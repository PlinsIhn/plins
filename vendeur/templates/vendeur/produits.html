{% extends 'vendeur/base_vendeur.html' %}
{% load static %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/liste_produits.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">


{% endblock %}

{% block content %}

  <!-- style 1 -->

  <div class="search-bar-sticky">
    <form method="GET" action="#" class="mb-1">
      <div class="input-group search-group">
        <!-- Champ -->
          <input 
          type="text" 
          name="q" 
          class="form-control search-input" 
          placeholder="Rechercher un produit..." 
          aria-label="Rechercher" />

        <!-- Cam√©ra -->
        <button type="button" class="btn btn-light border-0 search-addon text-primary">
          <i class="bi bi-camera"></i>
        </button>

        <!-- Recherche -->
        <button type="submit" class="btn border-0 bg-transparent text-primary search-addon">
          <i class="bi bi-search"></i>
        </button>
      </div>
    </form>
  </div>

  <!--  style 2 -->
  {% if produits %}
    <!-- Grille responsive de cartes -->
    <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 row-cols-xl-6 g-2 mt-1">

      {% for prod in produits %}
        {% url 'acheteur_detail_produit' produit_id=prod.id as url_detail %}
        <div class="col">
          <div class="card h-100 position-relative">

            <a href="{% url 'acheteur_detail_produit' prod.id %}" class="text-decoration-none text-dark">

            {% if prod.promo_est_active %}
                <span class="badge-promo"><strong>- {{ prod.reduction_pourcentage}}% </strong></span>
            {% elif prod.est_nouveau %}
                <span class="badge-nouveau">Vaovao</span>
            {% endif %}
          
              <img src="{{ prod.image_profil_produit.url }}" class="produit-img" alt="{{ prod.nom_produit }}" onerror="this.src='https://via.placeholder.com/150'" />
            </a>

            <div class="card-body nom_prix">
              <div class="small text-truncate fw-semibold">{{ prod.nom_produit }}</div>
                
              <div class="fw-bold text-primary" style="font-size: 0.7em;">

                {% if prod.promo_est_active %}
                  <span class="text-danger">{{ prod.get_prix_minimum }} Ar</span> |
                {% else %}
                  <span>{{ prod.get_prix_minimum }} Ar</span> |
                {% endif %}
                <span class="text-muted">stock : {{ prod.stock_total }}</span>
                | <a class="text-decoration-none btn-outline-danger" href="{% url 'modifier_produit' prod.id %}"><i class="fas fa-edit"></i></a>
              </div>
            

              <div class="d-flex justify-content-between align-items-center mt-2">

                <!-- Copier le lien -->
                <div class="text-center text-muted" style="flex: 1; font-size: 0.5em;">
                  <button id="btn-copier-lien-{{ prod.id }}" class="btn btn-link p-0 text-muted">
                    <span class="btn btn-sm btn-outline-success">
                      <i class="bi bi-link-45deg"></i>
                    </span>
                  </button>
                  <input type="text" id="input-copie-url-{{ prod.id }}" value="{{ request.scheme }}://{{ request.get_host }}{% url 'acheteur_detail_produit' produit_id=prod.id %}" style="position:absolute; left:-9999px;">
                  <div id="message-copier-{{ prod.id }}" style="display:none; color: green; font-size: 0.8em;">copi√© !</div>
                </div>

                <!-- Vue (oeil + badge) -->
                <div class="text-center" style="flex: 1; margin-top: 10px;">
                  <div class="position-relative d-inline-block">
                    <a href="#"><i class="bi bi-eye"></i></a>
                      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.7em;">
                        999k
                      </span>
                  </div>
                </div>

                <!-- Supprimer -->
                <div class="text-end" style="flex: 1; font-size: 0.5em;">
                  <a href="#"
                    class="btn btn-sm btn-outline-danger btn-delete"
                    title="Supprimer"
                    data-id="{{ prod.id }}"
                    data-name="{{ prod.nom_produit }}">
                    <i class="bi bi-trash3"></i>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <script>
          /* tsy maintsy mipetraka eto ity */
          (function() {
          const btn = document.getElementById("btn-copier-lien-{{ prod.id }}");
          const msg = document.getElementById("message-copier-{{ prod.id }}");
          const input = document.getElementById("input-copie-url-{{ prod.id }}");

          btn.addEventListener("click", function() {
            const url = input.value;

            // Si navigateur supporte Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
              navigator.clipboard.writeText(url).then(function() {
                afficherMessage();
              }).catch(function(err) {
                fallbackCopie();
              });
            } else {
              // Fallback : s√©lectionner l‚Äôinput cach√© et copier
              fallbackCopie();
            }

            function fallbackCopie() {
              input.select();
              input.setSelectionRange(0, 99999); // Pour iOS
              try {
                const success = document.execCommand('copy');
                if (success) {
                  afficherMessage();
                } else {
                  alert("Impossible de copier. Copiez manuellement : " + url);
                }
                } catch (err) {
                  alert("Erreur de copie : " + err);
                }
              }

              function afficherMessage() {
                msg.style.display = "block";
                setTimeout(() => msg.style.display = "none", 3000);
              }
            });
          })();
        </script>
      {% endfor %}
    </div>

    <!-- Modal confirmation suppression -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="deleteForm" method="post">
            {% csrf_token %}

            <div class="modal-header">
              <h5 class="modal-title" id="confirmDeleteLabel">Confirmer la suppression</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>

            <div class="modal-body">
              ü§î Tena s√ªr enao fa ho fafana ny etana : <strong id="productName"></strong> an ? Fa nahoana kosa
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">tsia</button>
              <button type="submit" class="btn btn-danger">fafana</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    {% else %}
      <p class="text-center mt-4">Aucun produit disponible pour le moment.</p>
  {% endif %}

{% endblock %}

{% block scripts %}

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

 <script>
  document.addEventListener('DOMContentLoaded', function () {
    const deleteButtons = document.querySelectorAll('.btn-delete');
    const deleteForm = document.getElementById('deleteForm');
    const productNameSpan = document.getElementById('productName');
    const modalElement = document.getElementById('confirmDeleteModal');

    // V√©rifie que le modal existe dans le DOM avant de continuer
    if (!modalElement || !deleteForm || !productNameSpan) {
      console.error("‚ö†Ô∏è Le modal ou ses √©l√©ments internes sont introuvables dans le DOM.");
      return;
    }

    const modal = new bootstrap.Modal(modalElement);

    // Pour chaque bouton "Supprimer", on ajoute un √©couteur d'√©v√©nement
    deleteButtons.forEach(button => {
      button.addEventListener('click', function (e) {
        e.preventDefault();

        const prodId = this.getAttribute('data-id');
        const prodName = this.getAttribute('data-name');
        const actionUrl = `/vendeur/produit/${prodId}/supprimer/`;

        // Met √† jour le formulaire et le nom du produit
        deleteForm.action = actionUrl;
        productNameSpan.textContent = prodName;

        // Affiche le modal
        modal.show();
      });
    });
  });
</script>

  
{% endblock %}