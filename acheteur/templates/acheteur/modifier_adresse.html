{% extends 'acheteur/base_acheteur.html' %}
{% load static %}

{% block content %}

<!-- CSS mitovy tanteraka amin'ny ajouter_adresse.html -->

    <style>
            .box {
                border-radius: 10px; 
                width: 90%; 
                margin-top: 10px;  
                box-shadow: 1px 4px 10px rgba(0, 0, 0, 0.5); 
                padding-top: 10px;
            }

            label {
                font-size: 0.8em;
            }
            .ajouter_produit_titre {
                text-align: center;
                color: rgb(243, 7, 101);
            }
            .custom-label {
            position: absolute;
            top: -1rem;
            left: 1.5rem;
            background: white;
            z-index: 1;
            color: rgb(38, 50, 212);
            }

            .custom-input {
                border: 1px solid #c7c7c7;
                border-radius: 5px;
            }

            .block-error {
            display: block;
            color: #dc3545; /* Rouge Bootstrap */
            background-color: #f8d7da; /* Rose clair */
            padding: 0.2rem 0.5rem;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            font-size: 0.7rem;
            position: absolute;
            }

            .form-control::placeholder {
                font-size: 0.7rem;
                color: #b7b7b7;
            }

            .form-control::-webkit-input-placeholder {
            font-size: 0.7rem;
            }

            .form-control:-ms-input-placeholder {
                font-size: 0.7rem;
            }
            #preview-container {
                display: none;
                margin-top: 0.5rem;
                }
            #preview-container img {
                width: 40px;
                height: 40px;
                border-radius: 8px;
                }
            .required-star {
                color : red;
            }
            #contenu-magasin{
                border-radius: 10px;
            }
        
        .btn-retour {
            text-decoration: none; 
            color: black; 
            border: 1px solid gray;
            padding-left: 10px;
            padding-right: 10px;
            background-color: rgb(240, 250, 120);
            border-radius: 5px;
            transition: 0.4s;
        }
        .btn-retour:hover {
            background-color: white;
            transition: 0.4s;
        }

    </style>


<a href="{% url 'liste_adresses' %}" class="btn-retour">&#8592;</a>

<form method="post">
    {% csrf_token %}

    <div class="box container mt-2">

        <h3 style="font-weight: bold; text-align: center;">Modifier adiresy</h3> <br>

        <div class="row justify-content-center">
            <div class="row mb-3"> 
                
                
                <div class="form-check">
                    {% if form.instance.est_defaut %}
                        <!-- Adresse déjà par défaut : checkbox désactivé mais on envoie quand même la valeur -->
                        <input type="hidden" name="est_defaut" value="on">
                        <input class="form-check-input" type="checkbox" id="id_est_defaut" checked disabled>
                    {% else %}
                        <!-- Adresse modifiable normalement -->
                        <input class="form-check-input" type="checkbox" id="id_est_defaut" name="est_defaut"
                            {% if form.est_defaut.value or not form.instance.pk %}checked{% endif %}>
                    {% endif %}

                    <label class="form-check-label" for="id_est_defaut" style="font-weight: bold;">
                        Adiresy ampiasaina
                    </label>
                </div>
                {% if form.est_defaut.errors %}
                    <div class="text-danger">{{ form.est_defaut.errors }}</div>
                {% endif %}
                

                <!-- Champ Nom de l'adresse -->
                
                <div class="col-md-6 position-relative mt-4">
                    <label for="id_nom_adresse" class="form-label custom-label" style="font-weight: bold;">
                        &nbsp;Titre <span class="required-star">*</span>&nbsp;
                    </label>
                    <input type="text" id="id_nom_adresse" name="nom_adresse" class="form-control"
                            value="{{ form.nom_adresse.value|default:'' }}" 
                            placeholder="Ohatra : Any antrano, Am-piasana, sns." required>
                    {% if form.nom_adresse.errors %}
                        <div class="text-danger">{{ form.nom_adresse.errors }}</div>
                    {% endif %}
                </div>

                <div class="col-md-6 position-relative mt-4" style="font-weight: bold;">
                    <label for="id_precision_adresse" class="form-label custom-label">
                        &nbsp;Fanamafisana&nbsp;
                    </label>
                    <input id="id_precision_adresse" name="precision_adresse" class="form-control"
                            rows="3" placeholder="Ex: Près de l'école, bâtiment rouge, etc."
                            value="{{ form.precision_adresse.value|default:'' }}">
                    {% if form.precision_adresse.errors %}
                        <div class="text-danger">{{ form.precision_adresse.errors }}</div>
                    {% endif %}
                </div>

                <hr style="margin-top: 20px;">

                <div class="col-md-6 position-relative mt-4">
                    <label for="region" class="form-label custom-label">&nbsp;Région <span class="required-star">*</span>&nbsp;</label>
                    <select class="form-select" id="region" name="region">
                        <option value="">-- Sélectionnez une région --</option>
                    </select>
                </div>

                <div class="col-md-6 position-relative mt-4">
                    <label for="district" class="form-label custom-label">&nbsp;District <span class="required-star">*</span>&nbsp;</label>
                    <select class="form-select" id="district" name="district" disabled>
                        <option value="">-- Sélectionnez un district --</option>
                    </select>
                </div>
        
                <div class="col-md-6 position-relative mt-4">
                    <label for="commune" class="form-label custom-label" >&nbsp;Commune <span class="required-star">*</span>&nbsp;</label>
                    <select class="form-select" id="commune" name="commune" disabled>
                        <option value="">-- Sélectionnez une commune --</option>
                    </select>
                </div>

                <div class="col-md-6 position-relative mt-4">
                    <label for="fokontany" class="form-label custom-label">&nbsp;Fokontany <span class="required-star">*</span>&nbsp;</label>
                    <select class="form-select" id="fokontany" name="fokontany" disabled>
                        <option value="">-- Sélectionnez un fokontany --</option>
                    </select>
                </div>

                <input type="hidden" name="adresse" id="adresse_id">

            </div>
        </div>

        <div class="pb-2  text-end" style="margin-right: 15px;">
            <button type="submit" class="btn btn-outline-success">
                <i class="fas fa-edit"></i> Modifier
            </button>
        </div>
    </div>

</form>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<script>
    async function fetchAndPopulate(url, targetSelect, resetBelow = [], selectedValue = "", resetId = true) {
        const res = await fetch(url);
        const data = await res.json();

        targetSelect.innerHTML = '<option value="">-- Choisissez --</option>';
        data.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item;
            opt.textContent = item;
            if (item === selectedValue) {
                opt.selected = true;
            }
            targetSelect.appendChild(opt);
        });

        targetSelect.disabled = false;
        resetBelow.forEach(select => {
            select.innerHTML = '<option value="">-- Choisissez --</option>';
            select.disabled = true;
        });

        // ⚠️ On ne reset l'ID que si on change volontairement (pas lors du pré-remplissage)
        if (resetId) {
            document.getElementById('adresse_id').value = "";
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const regionSelect = document.getElementById('region');
        const districtSelect = document.getElementById('district');
        const communeSelect = document.getElementById('commune');
        const fokontanySelect = document.getElementById('fokontany');
        const adresseIdInput = document.getElementById('adresse_id');

        // Valeurs actuelles envoyées par Django
        const regionActuelle = "{{ region_actuelle|escapejs }}";
        const districtActuel = "{{ district_actuel|escapejs }}";
        const communeActuelle = "{{ commune_actuelle|escapejs }}";
        const fokontanyActuel = "{{ fokontany_actuel|escapejs }}";

        // Pré-remplissage
        fetchAndPopulate('/vendeur/api/regions/', regionSelect, [], regionActuelle, false).then(() => {
            if (regionActuelle) {
                fetchAndPopulate(`/vendeur/api/districts/?region=${regionActuelle}`, districtSelect, [communeSelect, fokontanySelect], districtActuel, false).then(() => {
                    if (districtActuel) {
                        fetchAndPopulate(`/vendeur/api/communes/?region=${regionActuelle}&district=${districtActuel}`, communeSelect, [fokontanySelect], communeActuelle, false).then(() => {
                            if (communeActuelle) {
                                fetchAndPopulate(`/vendeur/api/fokontanys/?region=${regionActuelle}&district=${districtActuel}&commune=${communeActuelle}`, fokontanySelect, [], fokontanyActuel, false).then(() => {
                                    // Charger l’ID de l’adresse uniquement quand tout est prêt
                                    if (regionActuelle && districtActuel && communeActuelle && fokontanyActuel) {
                                        fetch(`/vendeur/api/adresse-id/?region=${regionActuelle}&district=${districtActuel}&commune=${communeActuelle}&fokontany=${fokontanyActuel}`)
                                            .then(res => res.json())
                                            .then(data => {
                                                if (data.id) {
                                                    adresseIdInput.value = data.id;
                                                }
                                            });
                                    }
                                });
                            }
                        });
                    }
                });
            }
        });

        // Listeners quand on change volontairement
        regionSelect.addEventListener('change', () => {
            const region = regionSelect.value;
            if (region) {
                fetchAndPopulate(`/vendeur/api/districts/?region=${region}`, districtSelect, [communeSelect, fokontanySelect]);
            }
        });

        districtSelect.addEventListener('change', () => {
            const region = regionSelect.value;
            const district = districtSelect.value;
            if (region && district) {
                fetchAndPopulate(`/vendeur/api/communes/?region=${region}&district=${district}`, communeSelect, [fokontanySelect]);
            }
        });

        communeSelect.addEventListener('change', () => {
            const region = regionSelect.value;
            const district = districtSelect.value;
            const commune = communeSelect.value;
            if (region && district && commune) {
                fetchAndPopulate(`/vendeur/api/fokontanys/?region=${region}&district=${district}&commune=${commune}`, fokontanySelect);
            }
        });

        fokontanySelect.addEventListener('change', async () => {
            const region = regionSelect.value;
            const district = districtSelect.value;
            const commune = communeSelect.value;
            const fokontany = fokontanySelect.value;

            if (region && district && commune && fokontany) {
                const res = await fetch(`/vendeur/api/adresse-id/?region=${region}&district=${district}&commune=${commune}&fokontany=${fokontany}`);
                const data = await res.json();

                if (data.id) {
                    adresseIdInput.value = data.id;
                } else {
                    adresseIdInput.value = "";
                }
            }
        });
    });
</script>

{% endblock %}
