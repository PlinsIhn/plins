{% extends 'acheteur/base_acheteur.html' %}
{% load static %}

{% block extra_css %} 
<link rel="stylesheet" href="{% static 'css/liste_produits.css' %}">

<style>
/* ðŸ”¹ Animation douce Ã  lâ€™arrivÃ©e des nouveaux produits */
.produit-card {
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.6s ease, transform 0.6s ease;
}
.produit-card.visible {
  opacity: 1;
  transform: translateY(0);
}

/* ðŸ”¹ Message de fin */
#fin-message {
  text-align: center;
  color: gray;
  margin: 1.5rem 0;
  display: none;
}
</style>
{% endblock %}

{% block content %}
<!-- ðŸ”¹ Barre de recherche -->
<div class="search-bar-sticky">
  <form method="GET" action="{% url 'acheteur_recherche_produit' %}" class="mb-1">
    <div class="input-group search-group">
      <input 
        type="text" 
        name="q" 
        class="form-control search-input" 
        placeholder="Hitady entana ...."
        value="{{ query }}"  
        aria-label="Rechercher" />

      {% if regions %}
        <select 
          name="region" 
          class="form-select"
          style="max-width: 120px; font-size: 0.7em; border: none; background-color: rgb(235, 248, 0);" 
          onchange="this.form.submit()">
          <option value="">Faritra rehetra</option>
          {% for region in regions %}
            <option value="{{ region }}" {% if selected_region == region %}selected{% endif %}>{{ region }}</option>
          {% endfor %}
        </select>
      {% endif %}

      <button type="submit" class="btn border-0 bg-transparent text-primary search-addon">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </form>
</div>

<!-- ðŸ”¹ RÃ©sultats -->
{% if produits %}
    <div id="produits-container" class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 row-cols-xl-6 g-2 mt-1">
      {% include 'acheteur/includes/produits_list.html' %}
    </div>

    <!-- ðŸ”¹ Message de fin -->
    <br>
    <div id="end-message" class="text-center text-muted my-3" style="display: none;">
      <p>izay daholo ny entana rehetra ðŸ˜Ž</p>
    </div>

  {% else %}
    <p class="text-center mt-4">Tsy mbola misy io entana io!</p>
    <hr>
  {% endif %}

{% endblock %}

{% block extra_js %}
<script>
let page = 2;
let loading = false;
let noMoreData = false;

// === ðŸ”¹ Fonction principale pour charger une page ===
async function chargerPage() {
  if (loading || noMoreData) return;
  loading = true;

  const params = new URLSearchParams(window.location.search);
  params.set('page', page);

  const response = await fetch(`?${params.toString()}`, {
    headers: { "X-Requested-With": "XMLHttpRequest" }
  });

  if (!response.ok) {
    loading = false;
    return;
  }

  const data = await response.json();
  if (data.produits_html.trim() !== '') {
    const container = document.querySelector('#produits-container');
    container.insertAdjacentHTML('beforeend', data.produits_html);

    // Effet dâ€™apparition douce
    const newCards = container.querySelectorAll('.produit-card:not(.visible)');
    newCards.forEach((card, i) => {
      setTimeout(() => card.classList.add('visible'), i * 100);
    });

    page++;
    loading = false;

    if (!data.has_next) {
      noMoreData = true;
      document.getElementById('end-message').style.display = 'block';
    }
  } else {
    noMoreData = true;
    document.getElementById('end-message').style.display = 'block';
  }
}

// === ðŸ”¹ PrÃ©chargement automatique selon la taille de lâ€™Ã©cran ===
async function prechargerSelonEcran() {
  let pagesACharger = 1;
  if (window.innerWidth >= 1200) pagesACharger = 3; // Ã©cran large (PC)
  else if (window.innerWidth >= 768) pagesACharger = 2; // tablette

  for (let i = 1; i < pagesACharger; i++) {
    await chargerPage();
  }
}

// === ðŸ”¹ DÃ©clenchement par scroll infini ===
window.addEventListener('scroll', async () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 300) {
    await chargerPage();
  }
});

// === ðŸ”¹ Animation dâ€™apparition initiale + prÃ©chargement ===
document.addEventListener('DOMContentLoaded', async () => {
  document.querySelectorAll('.produit-card').forEach((card, i) => {
    setTimeout(() => card.classList.add('visible'), i * 100);
  });

  await prechargerSelonEcran(); // ðŸ‘ˆ prÃ©charge plus de pages si grand Ã©cran
});
</script>
{% endblock %}
