{% extends 'acheteur/base_acheteur.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/liste_produits.css' %}">
{% endblock %}

{% block content %}
  <div class="search-bar-sticky">
    <form method="GET" action="{% url 'acheteur_recherche_produit' %}" class="mb-1">
      <div class="input-group search-group">
        <input type="text" name="q" class="form-control search-input"
          value="{{ query }}" placeholder="Hitady entana ...." aria-label="Rechercher" />
        <button type="button" class="btn btn-light border-0 search-addon">
          <i class="bi bi-camera"></i>
        </button>
        <button type="submit" class="btn border-0 bg-transparent text-primary search-addon">
          <i class="bi bi-search"></i>
        </button>
      </div>
    </form>
  </div>

  {% if produits %}
    <div id="produits-container" class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 row-cols-xl-6 g-2 mt-1">
      {% include 'acheteur/includes/produits_list.html' %}
    </div>

    <div id="loader" class="text-center my-3" style="display: none;">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Chargement...</span>
      </div>
    </div>
    
    <div id="end-message" class="text-center text-muted my-3" style="display: none;">
      <p>izay daholo ny entana rehetra ðŸ˜Ž</p>
    </div>

  {% else %}
    <p class="text-center mt-4">Aucun produit disponible pour le moment.</p>
  {% endif %}

  
  <style>
  #end-message p {
    font-style: italic;
    color: #6c757d;
    transition: opacity 0.5s ease-in;
  }

  /* Animation douce Ã  lâ€™ajout des cartes */
  .card {
    transition: opacity 0.5s ease-in;
  }
  </style>

{% endblock %}

{% block extra_js %}

  <script>
  /**
   * ðŸ”¹ Ã‰tape 1 : au tout dÃ©but, calculer le page_size et recharger la page si nÃ©cessaire
   * pour que Django affiche dÃ¨s le dÃ©part le bon nombre de produits
   */
  function getPageSize() {
    const width = window.innerWidth;
    if (width < 576) return 12;   // TÃ©lÃ©phone
    if (width < 992) return 25;   // Tablette
    return 65;                    // Ordinateur
  }

  const params = new URLSearchParams(window.location.search);
  if (!params.has('page_size')) {
    params.set('page_size', getPageSize());
    const newUrl = `${window.location.pathname}?${params.toString()}`;
    window.location.replace(newUrl);
  }

  </script>

  <script>
  /**
   * ðŸ”¹ Ã‰tape 2 : Gestion du scroll infini
   */
  let page = 2;
  let loading = false;
  let hasNext = true;

  window.addEventListener('scroll', () => {
    if (loading || !hasNext) return;

    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
      loadMore();
    }
  });

  function loadMore() {
    loading = true;
    document.getElementById('loader').style.display = 'block';
    const pageSize = getPageSize();

    fetch(`?page=${page}&page_size=${pageSize}`, { 
      headers: { 'X-Requested-With': 'XMLHttpRequest' } 
    })
      .then(response => {
        if (!response.ok) throw new Error('Erreur ' + response.status);
        return response.json();
      })
      .then(data => {
        const container = document.getElementById('produits-container');
        if (data.produits_html.trim() !== "") {
          container.insertAdjacentHTML('beforeend', data.produits_html);

          // Animation douce
          container.querySelectorAll('.card:not([data-animated])').forEach(el => {
            el.dataset.animated = true;
            el.style.opacity = 0;
            setTimeout(() => (el.style.opacity = 1), 50);
          });
        }

        if (!data.has_next) {
          hasNext = false;
          document.getElementById('end-message').style.display = 'block';
        } else {
          page++;
        }
      })
      .catch(err => console.error('Erreur de chargement:', err))
      .finally(() => {
        document.getElementById('loader').style.display = 'none';
        loading = false;
      });
  }
  </script>

{% endblock %}
